---
title: "RNA-Seq_differential_expression_analysis"
output: html_document
date: "2025-04-18"
---

```{r,packages}


suppressPackageStartupMessages({
  library("EnhancedVolcano")
  library("limma")
  library("biomaRt")
  library("annotables")
  library("tximport")
  library("apeglm")
  library("eulerr")
library("DESeq2")
  library("HGNChelper")
  library("tictoc")
  library("DESeq2")
  library("kableExtra")
  library("beeswarm")
  library("missMethyl")
  library("gridExtra")
  library("png")
  library("metafor")
  library("ggplot2")
  library("purrr")
library("metafor")
library("dplyr")
library("readxl")
library("ggplot2")
library("tidyverse")
library("magrittr")
library("readr")
library("eulerr")
library("RColorBrewer")
library("e1071")
  library("plotly") 
  library("pheatmap")

})

CORES=16

```
# Read the sample manifest and alignment summary

# I ran two types of aligment with kallisto (with and without ncRNA), I have comapred the result of the alingement and choosed the cDNA+ncRNA as the aligment since the aligment percentage is higher in this combo

```{r}
base <- "/mnt/vol1/Mouse_model_RNA_Seq/kallisto_results_plus_ncRNA/"
idx  <- "/mnt/vol1/Mouse_model_RNA_Seq/index"

samples <- read_tsv(file.path(base,"samples.txt"),col_names = "sample", show_col_types = FALSE)
samples$path <- file.path(base, samples$sample, "abundance.tsv")

align <- read_delim("/mnt/vol1/Mouse_model_RNA_Seq/kallisto_results_plus_ncRNA/alignment_summary.tsv")

old_align<-read_csv("/mnt/vol1/Mouse_model_RNA_Seq/kallisto_results/aligment_no_ncrna.csv", show_col_types = FALSE)

new_df <- align     %>% mutate(index = "cDNA + ncRNA",
                               rate = 100 * pseudoaligned/processed) %>%
  select(sample, index, rate)
old_df <- old_align %>% mutate(index = "cDNA only",
                               rate = 100 * pseudoaligned/processed) %>%
  select(sample, index, rate)

df <- bind_rows(new_df, old_df)

# Order samples by delta (new - old)
delta <- df %>% pivot_wider(names_from = index, values_from = rate) %>%
  mutate(delta = `cDNA + ncRNA` - `cDNA only`) %>%
  arrange(delta)
df$sample <- factor(df$sample, levels = delta$sample)

ggplot(df, aes(sample, rate, fill = index)) +
  geom_col(position = position_dodge(width = 0.75), width = 0.7) +
  labs(title = "Pseudoalignment rate by sample",
       x = "Sample", y = "Rate (%)", fill = "Run") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

# Import transcripts to gene level via trimport package

```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}

tx2gene <- read.csv(file.path("/mnt/vol1/Mouse_model_RNA_Seq/tx2gene_r115.csv"), stringsAsFactors = FALSE)
stopifnot(all(c("TXNAME","GENEID") %in% names(tx2gene)))

files <- file.path(base, samples$sample, "abundance.tsv")
names(files) <- samples$sample
stopifnot(all(file.exists(files)))

txi <- tximport(files,
                type = "kallisto",
                tx2gene = tx2gene[, c("TXNAME","GENEID")],
                countsFromAbundance = "lengthScaledTPM",
                ignoreTxVersion = TRUE)

txi$counts[1:2, 1:6] 

```

# Reading meta data that comes with the samples

```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}

pheno <- read_excel("/mnt/vol1/Mouse_model_RNA_Seq/minipump.xlsx",skip =1 )
colnames(pheno)

coldata <- pheno %>%
  filter(Sample %in% samples$sample) %>%
  arrange(match(Sample, samples$sample)) %>%
  mutate(
    Sex = factor(Sex, levels = c("F","M")),                  # F as baseline
    Treatment = factor(Intervention, levels = c("Saline","Ang-II"))  # Saline as baseline
  )

rownames(coldata) <- coldata$Sample


```

# Making DESeqDataSet from tximport


```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}

dds <- DESeqDataSetFromTximport(txi, colData = coldata,
                                design = ~ Sex + Treatment + Sex:Treatment)

```


# Filtering for low count and normalisation of the counts


```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}


keep <- rowSums(counts(dds)) >= 10
dds  <- dds[keep, ]

dds   <- estimateSizeFactors(dds)
norm_counts <- counts(dds, normalized = TRUE)
glimpse(norm_counts)

```


# Unsupervised clustering analyses

```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}

vsd <- vst(dds, blind = TRUE)

ann <- as.data.frame(colData(dds))[, c("Sex","Treatment"), drop = FALSE]

# sample–sample correlation heatmap
pheatmap(cor(assay(vsd)),
         annotation_col = ann,
         annotation_row = ann)

# PCA (colour = Treatment, shape = Sex)
plotPCA(vsd, intgroup = c("Treatment","Sex"))

## Fit model (set baselines)
dds$Sex       <- relevel(factor(dds$Sex), "F")
dds$Treatment <- relevel(factor(dds$Treatment), "Saline")
design(dds)   <- ~ Sex + Treatment + Sex:Treatment
dds <- DESeq(dds)


```

```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}

resultsNames(dds)

# baseline (Saline): M vs F
coef_sex <- "Sex_M_vs_F"   

# Ang-II vs Saline in females (F is baseline sex)
coef_trt <- "Treatment_Ang.II_vs_Saline"  

# (Ang-II effect in M) & (Ang-II effect in F)
coef_int <- "SexM.TreatmentAng.II"        

```

#  RAW results vs Shrinking the log2 fold changes

```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}

# RAW results

# 1. Within each Sex

# 1.1 Female: Ang-II vs Saline  
res_F_raw   <- results(dds, name = coef_trt)
# 1.2 Male: Ang-II vs Saline  
res_M_raw   <- results(dds, contrast = list(c(coef_trt, coef_int)))


# 2. Effect of Ang-II treatment between sex

# Interaction: difference of treatment effect between sexes (M & F)
res_int_raw <- results(dds, name = coef_int)

# 3. Baseline (Saline): M vs F
res_bsl_raw <- results(dds, name = coef_sex)



# Shrinkage results

res_F_shr   <- lfcShrink(dds, coef     = coef_trt, type = "ashr")
res_M_shr   <- lfcShrink(dds, contrast = list(c(coef_trt, coef_int)), type = "ashr")
res_int_shr <- lfcShrink(dds, coef     = coef_int, type = "ashr")
res_bsl_shr <- lfcShrink(dds, coef     = coef_sex, type = "ashr")


make_df <- function(raw, shr, label){
  data.frame(
    gene    = rownames(raw),
    lfc_raw = raw$log2FoldChange,
    lfc_shr = shr$log2FoldChange,
    FDR_raw = raw$padj,                 # keep the same FDR for both facets
    contrast = label,
    stringsAsFactors = FALSE
  )
}

res_all <- bind_rows(
  make_df(res_F_raw,   res_F_shr,   "Female: Ang-II vs Saline"),
  make_df(res_M_raw,   res_M_shr,   "Male: Ang-II vs Saline"),
  make_df(res_int_raw, res_int_shr, "Interaction: (M − F) treatment effect"),
  make_df(res_bsl_raw, res_bsl_shr, "Baseline (Saline): M vs F")
)

# Long format for faceted volcano (Raw vs Shrunken)
res_long <- res_all %>%
  mutate(
    hit_raw = !is.na(FDR_raw) & FDR_raw <= 0.05 & abs(lfc_raw) >= 0.5,
    hit_shr = !is.na(FDR_raw) & FDR_raw <= 0.05 & abs(lfc_shr) >= 0.5
  ) %>%
  select(gene, contrast, FDR_raw, lfc_raw, lfc_shr, hit_raw, hit_shr) %>%
  pivot_longer(
    cols = c(lfc_raw, lfc_shr, hit_raw, hit_shr),
    names_to = c(".value","lfc_type"),
    names_pattern = "(lfc|hit)_(raw|shr)"
  ) %>%
  mutate(
    lfc_type = recode(lfc_type,
      raw = "Raw LFC (before)",
      shr = "Shrunken LFC (after)"
    ),
    lfc_type = factor(lfc_type, levels = c("Raw LFC (before)", "Shrunken LFC (after)")),
    contrast = factor(contrast, levels = c("Female: Ang-II vs Saline",
                                           "Male: Ang-II vs Saline",
                                           "Interaction: (M − F) treatment effect",
                                           "Baseline (Saline): M vs F"))
  )

# Axis limits (compact but adaptive)
x_max <- quantile(abs(res_long$lfc), 0.995, na.rm = TRUE)
x_lim <- c(-max(1.5, x_max), max(1.5, x_max))
y_max <- quantile(-log10(res_long$FDR_raw), 0.995, na.rm = TRUE)
y_lim <- c(0, max(5, y_max))

# Faceted volcano: rows = contrasts, columns = Raw vs Shrunken
ggplot(res_long, aes(lfc, -log10(FDR_raw), colour = hit)) +
  geom_point(alpha = 0.6, size = 1.2) +
  geom_vline(xintercept = c(-0.5, 0.5), linetype = 2) +
  geom_hline(yintercept = -log10(0.05), linetype = 2) +
  coord_cartesian(xlim = x_lim, ylim = y_lim) +
  facet_grid(contrast ~ lfc_type, switch = "y") +
  scale_colour_manual(values = c("FALSE" = "grey60", "TRUE" = "steelblue4"),
                      labels = c("FALSE" = "FDR>0.05 or |LFC|<0.5", "TRUE" = "FDR≤0.05 & |LFC|≥0.5"),
                      name = NULL) +
  labs(
    title = "Volcano comparison: Raw vs Shrunken (ashr)",
    x = "log2 fold change",
    y = expression(-log[10]("FDR from unshrunken fit"))
  ) +
  theme_minimal(base_size = 11) +
  theme(
    legend.position = "bottom",
    strip.placement = "outside",
    strip.background = element_blank(),
    strip.text.x = element_text(face = "bold"),
    strip.text.y.left = element_text(angle = 0, face = "bold"),
    panel.grid.minor = element_blank()
  )


```

```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}





```


```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}
sessionInfo()


```








